
<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Dashboard</title>
    <meta name="description" content="Dashboard">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="apple-touch-icon" href="apple-icon.png">
    <link rel="shortcut icon" href="favicon.ico">

    <link rel="stylesheet" href="vendors/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="vendors/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="vendors/themify-icons/css/themify-icons.css">
    <link rel="stylesheet" href="vendors/flag-icon-css/css/flag-icon.min.css">
    <link rel="stylesheet" href="vendors/selectFX/css/cs-skin-elastic.css">
    <link rel="stylesheet" href="vendors/jqvmap/dist/jqvmap.min.css">

    <link rel="stylesheet" href="assets/style.css">

    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800' rel='stylesheet' type='text/css'>
    <style type="text/css" media="screen">


        .li{
            display: inline-block;;
        }
        /*.float-right{*/
        /*display: inline-block;*/
        /*}*/

        .post{
            background: lightgrey;
            width: 1000px;
            height: auto;
            border: hidden;
            text-align: left;
            color: black;
            font-size: 12px;
            margin-bottom: 10px;
            overflow-y: auto;
        }


        #chat{
            width: 1000px;
            height: 400px;
            border-style: solid;
            border-color: dodgerblue;
            border-width: 2px;
        }

        .collapsible{
            display: block;
            background: none;
            border: none;
        }

        #username{
            font-size: 20px;
            color: white;
        }

        #userHref{
            font-size: 20px;
            color: white;
        }


        #postInfo{
            display: inline-block;
            font-size: 14px;
        }

        #topicInfo{
            display: inline-block;
            font-size: 14px;
        }

        #forumId{
            display: inline-block;
            font-size: 14px;
        }

        .chat {
            /*width: 1000px;*/
            /*height: 400px;*/
            border: dodgerblue;

        }

        .postTime{
            width: inherit;
            height: 20px;
            background-color: dodgerblue;
            color: white;
        }

        .userInfo{
            width: 28%;
            height: inherit;
            padding: 1%;
            float: left;
            display: block;
            background-color: whitesmoke;
        }

        .info{
            width: 68%;
            padding: 1%;
            height: inherit;
            float: right;
            display: block;
            background-color: gray;
        }

        .margin0{
            margin: 0;
            line-break: auto;
            font-size: small;
        }

        .userName{
            font-weight: bold;
            font-size: 18px;
            color: dodgerblue;
        }
        .userStatus{
            font-weight: bold;
        }
        .topicName{
            font-weight: bold;
        }

        #addFilterButton{

        }





        button{
            cursor: pointer;
        }

        #ctxMenu{
            display:none;
            z-index:100;
        }


        #ctxMenuUsername{
            display:none;
            z-index:100;
        }

        #ctxMenuTopic{
            display:none;
            z-index:100;
        }

        menu {
            position:absolute;
            display:block;
            left:0px;
            top:0px;
            height:20px;
            width:auto;
            padding:0;
            margin:0;
            border:1px solid;
            background-color:white;
            font-weight:normal;
            white-space:nowrap;
        }
        menu:hover{
            background-color:#eef;
            font-weight:bold;
        }
        menu:hover > menu{
            display:block;
        }
        menu > menu{
            display:none;
            position:relative;
            top:-20px;
            left:100%;
            width:55px;
        }
        menu[title]:before{
            content:attr(title);
        }
        menu:not([title]):before{
            content:"\2630";
        }






    </style>
</head>



<body>

<div id="wholething">
    <!-- Left Panel -->

    <aside id="left-panel" class="left-panel">
        <nav class="navbar navbar-expand-sm navbar-default" style="position: fixed">

            <div id="main-menu" class="main-menu collapse navbar-collapse">
                <ul style="list-style: none" class="nav navbar-nav">
                    <li class="active">
                        <a href="backup.html"> <i class="menu-icon fa fa-dashboard"></i>Dashboard </a>
                    </li>
                    <h3 class="menu-title">SEARCH</h3><!-- /.menu-title -->
                    <li class="menu-item-has-children dropdown">
                        <!--<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> <i class="menu-icon fa fa-laptop"></i>SEARCH</a>-->
                        <ul class="sub-menu children dropdown-menu">
                            <li><i class="fa fa-puzzle-piece"></i><a href="backup.html" onclick="return saveqfunc()">Search Posts</a></li>
                        </ul>
                    </li>

                    <h3 class="menu-title">SUBQUERIES</h3><!-- /.menu-title -->
                    <li class="menu-item-has-children dropdown">
                        <!--<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> <i class="menu-icon fa fa-tasks"></i>SubQueries</a>-->
                        <ul class="sub-menu children dropdown-menu">
                            <li><i class="menu-icon fa fa-fort-awesome"></i><a href="all.html" onclick="return saveqfunc()">All</a></li>
                        </ul>
                    </li>
                    <h3 class="menu-title">EXTRAS</h3><!-- /.menu-title -->
                    <li class="menu-item-has-children dropdown">
                        <!--<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> <i class="menu-icon fa fa-glass"></i>Extras</a>-->
                        <ul class="sub-menu children dropdown-menu">
                            <li><i class="menu-icon fa fa-sign-in"></i><a href="page-login.html" onclick="return saveqfunc()">Logout</a></li>
                            <li><i class="menu-icon fa fa-sign-in"></i><a href="" onclick="return saveqfunc()">Guide to Dashboard</a></li>
                            <li><i class="menu-icon fa fa-sign-in"></i><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html" onclick="return saveqfunc()">ElasticSearch Reference</a></li>

                        </ul>
                    </li>
                </ul>
            </div><!-- /.navbar-collapse -->
        </nav>
    </aside><!-- /#left-panel -->

    <!-- Left Panel -->

    <!-- Right Panel -->

    <div id="right-panel" class="right-panel">

        <!-- Header-->
        <header id="header" class="header">

            <div class="header-menu"></div>

        </header><!-- /header -->
        <!-- Header-->

        <div class="breadcrumbs">
            <!--<div class="col-sm-4" style="display: block;">-->
            <div class="page-header">
                <div class="page-title">
                    <h1>Dashboard</h1>
                </div>
            </div>
            <!--</div>-->

            <div class="col-sm-8">
                <!--<div id="editor" style="height: 400px; width: 1000px;">{-->
                <!--"query": {-->
                <!--"match_phrase" : {-->
                <!--"text" : "help"-->
                <!--}-->
                <!--}-->
                <!--}-->
                <!---->
                <!--</div>-->


                <div id="editor" style="height: 400px; width: 400px;">{
                    "size" : 20,
                    "query": {
                    "bool": {
                    "must": [
                    { "match_phrase": { "text":   "help"        }}
                    ],
                    "filter": [
                    { "term":  { "userName": "cookerblocks" }}
                    ],
                    "must_not" : [
                    ],
                    "should" : [
                    ]
                    }
                    }
                    }
                </div>

                <div id="editorExecute" style="height: 400px; width: 400px; margin-left: 500px; margin-top: -400px"></div>

                <!--<menu id="ctxMenu">-->
                <menu id="ctxMenu" class="ctxMenu" title="Create Subquery"></menu>
                <!--</menu>-->

                <menu id="ctxMenuUsername" class="ctxMenu">
                    <menu id="userMenuByUser" title="Get All By User"></menu>
                    <menu id="userMenuByUserAndQuery" title="Refine By User"></menu>
                </menu>

                <menu id="ctxMenuTopic" class="ctxMenu">
                    <menu id="userMenuByTopic" title="Get All By Topic"></menu>
                    <menu id="userMenuByTopicAndQuery" title="Refine By Topic"></menu>
                </menu>


                <!--<button id="addFilterButton" onclick=addFilter()>Add Filter</button>-->

                <div id="addFilterDialogbox">
                    <p>Choose filters:</p>
                    <form id="filterForm">
                        <p id="formContainer">

                        </p>
                    </form>
                    <div>

                    </div>
                </div>
                <br>
                <button id="button" onclick="sendCode('editor')">Run Query</button>
                <!--onclick=sendCode("editor")-->
                <button id="prettyprintbutton" onclick=prettyprintdisplay()>Pretty Print</button>
                <!--<button id="displaywholequerybutton" onclick=displaywholequery()>Display Query</button>-->
                <button id="runoriginalquery" style="display: none;: hidden">Remove user/query filter</button>


            </div>

            <!--<div class="col-sm-8">-->
            <!--<div class="page-header float-right">-->
            <!--<div class="page-title">-->
            <!--<ol class="breadcrumb text-right">-->
            <!--<li class="active">Dashboard</li>-->
            <!--</ol>-->
            <!--</div>-->
            <!--</div>-->
            <!--</div>-->
        </div>

        <div class="break" style="padding-top: 20px"></div>

        <div class="content mt-3">
            <h3>Search Query Results</h3>
            <div class="col-sm-12">
                <div class="alert  alert-success alert-dismissible fade show" role="alert">
                    <span class="info" id="info" style="visibility: hidden" class="badge badge-pill badge-success">Success! The following posts were found.</span>
                    <br>
                </div>
            </div>


            <div class="break" style="padding-top: 30px"></div>


            <div class="posts" id="posts">
            </div>

            <div id="addSubqueryPopup" title="Create Subquery" style="display: none; ">
                <label>Name your query: </label>
                <input id="subqName" name="subqName" style="display: block"> </input>
                <br>
                <div id="subquerySelected" style="display: block; margin-top: 10px; width: 500px; height: 400px; font-size: 12px"></div>
                <br>
                <button id="createSubqueryButton">Create Subquery</button>

            </div>

        </div> <!-- .content -->
    </div><!-- /#right-panel -->
</div>

</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.1/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.1/theme-cobalt.js" integrity="sha256-OEJvWvZJvQ8cFFLk43d1UF5DHqWdikG1n8CJQSP70TA=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.1/mode-yaml.js" integrity="sha256-95xNUgbfIXvRXJezV53+JM5HPO6PnJ+wZ7/GwdesKAE=" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>

<script src="https://code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>

<link rel="stylesheet" href="https://code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css" />


<script>

//    if(sessionStorage.subqcode || sessionStorage.subqname){
//        alert("lol")
////        document.getElementById('subqName').value = sessionStorage.subqname;
////        editorSubq.setValue(sessionStorage.subqcode);
//
//    }

    var menuDisplayed = false;
    var userMenuDisplayed = false;
    var topicMenuDisplayed = false;
    var ctxMenu = document.getElementById("ctxMenu");
    var userFilterArray =[];
    var getPostsByUser = document.getElementById('userMenuByUser');
    var getPostsByUserAndQuery = document.getElementById('userMenuByUserAndQuery');
    var usermenu = document.getElementById('ctxMenuUsername');
    var topicmenu = document.getElementById('ctxMenuTopic');
    var getPostsByTopic = document.getElementById('userMenuByTopic');
    var getPostsByTopicAndQuery = document.getElementById('userMenuByTopicAndQuery');
    var usernames = document.getElementsByClassName('userName');
    var editor = ace.edit("editor");


    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/json");
    editor.focus();
    editor.setOptions({
        enableBasicAutocompletion: true,
        enableSnippets: true,
        enableLiveAutocompletion: true
    });

    var value = editor.getValue();

    if(sessionStorage.editorCode){
        alert(sessionStorage.editorCode)
        editor.setValue(prettyprint(sessionStorage.editorCode));
    }
    else{
        sessionStorage.editorCode = value;
        editor.setValue(prettyprint(value));
    }
    //editor.setValue(prettyprint(value));


    var editorX = ace.edit("editorExecute");
    editorX.setTheme("ace/theme/monokai");
    editorX.session.setMode("ace/mode/json");
    editorX.setOptions({
        enableBasicAutocompletion: true,
        enableSnippets: true,
        enableLiveAutocompletion: true,
    });
    editorX.setReadOnly(true);


    var editorSubq = ace.edit("subquerySelected");
    editorSubq.setTheme("ace/theme/monokai");
    editorSubq.session.setMode("ace/mode/json");
    editorSubq.setOptions({
        enableBasicAutocompletion: true,
        enableSnippets: true,
        enableLiveAutocompletion: true,
    });

    //    var value = editor.getValue();


    if(sessionStorage.editorXCode){
        editorX.setValue(prettyprint(sessionStorage.editorXCode));
    }
    else{
        sessionStorage.editorXCode = value;
        editorX.setValue(prettyprint(value));
    }
     //  editorX.setValue(prettyprint(value));


    var nameclickedon = "";
    var topicnameclickedon = "";
    var topicIDlickedon = "";
    var bool = false;

    displayFilters();


    if(sessionStorage.runoriginalquerybutton){
        alert("Filter applued!");
        var runoriginalquerybutton = document.getElementById('runoriginalquery');
        runoriginalquerybutton.style.display = "inline";
    }else{
        sessionStorage.runoriginalquerybutton = "false"
    }



    $(window).click(function(){
        if(menuDisplayed){
            menuDisplayed = false;
            ctxMenu.style.display = "";
            ctxMenu.style.left = "";
            ctxMenu.style.top = "";
            var runoriginalquerybutton = document.getElementById('runoriginalquery');
            runoriginalquerybutton.style.display = "none";
            sessionStorage.runoriginalquerybuttondisp = "false";

        }
    });
    $( "#editor" ).contextmenu(function(event) {
        event.preventDefault();
        ctxMenu.style.display = "block";
        ctxMenu.style.left = (event.pageX - 10)+"px";
        ctxMenu.style.top = (event.pageY - 10)+"px";
        menuDisplayed = true;
    });

    $( "#editorExecute" ).contextmenu(function(event) {
        event.preventDefault();
        ctxMenu.style.display = "block";
        ctxMenu.style.left = (event.pageX - 10)+"px";
        ctxMenu.style.top = (event.pageY - 10)+"px";
        menuDisplayed = true;
    });

    if(sessionStorage.popupdisplayed === undefined)
        sessionStorage.popupdisplayed = false;

    var popupdisplayed = false
    alert(sessionStorage.subqcode +" UM "+sessionStorage.subqname+" "+sessionStorage.popupdisplayed)
//    if(sessionStorage.subqcode === JSON.parse("{undefined}") || sessionStorage.subqname === JSON.parse("{undefined}")){
//        alert("UNDEF wtf")
//        alert(sessionStorage.subqname)
//        document.getElementById('subqName').value = sessionStorage.subqname;
//        editorSubq.setValue(sessionStorage.subqcode);
//        popupdisplayed = true;
//        $( "#addSubqueryPopup" ).dialog({
//            width: 600,
//            height: 600
//        });
//    }

    if(sessionStorage.popupdisplayed.toString() === 'true'){
        alert("hey!!")
        alert(sessionStorage.subqname)
        alert(sessionStorage.subqcode)

        document.getElementById('subqName').value = sessionStorage.subqname;
        editorSubq.setValue(sessionStorage.subqcode);
        sessionStorage.popupdisplayed = true;
        $( "#addSubqueryPopup" ).dialog({
            width: 600,
            height: 600
        });
    }

    ctxMenu.addEventListener("click",function (event){
        if(menuDisplayed) {
            var selectedText = editor.getSelectedText();

            menuDisplayed = false;
            ctxMenu.style.display = "";
            ctxMenu.style.left = "";
            ctxMenu.style.top = "";
//            document.getElementById('subquerySelected').setValue(selectedText);

            editorSubq.setValue(selectedText);
            document.getElementById('subqName').value = '';
            document.getElementById("createSubqueryButton").disabled = true;

            $( "#addSubqueryPopup" ).dialog({
                width: 600,
                height: 600
            });
            popupdisplayed = true;
            sessionStorage.popupdisplayed = true;

            $("input[name='subqName']").on("keyup", function(){
                if($(this).val() != "") {
                    document.getElementById("createSubqueryButton").disabled = false;
                }
                else{
                    alert("Must have a name!");
                }
            });


        }
    },false);

    document.getElementById('createSubqueryButton').addEventListener("click", function(event){
        var subqName = $("#subqName").val();
        var selectedText = editor.getSelectedText();

        //todo check if subquery doesnt already exist
        // todo add subquery to backend

        var existsAlreadyFlag = false;
        for(var i in allFilterObjectsArray){
            var obj = JSON.parse(allFilterObjectsArray[i]);
            if(obj.queryName.toLowerCase() === subqName.toLowerCase()){
                existsAlreadyFlag = true;
                break;
            }
        }

        if(existsAlreadyFlag){
            alert("Error! Subquery Exists already!")
            $('#addSubqueryPopup').dialog('close');
        }
        else{
            //adding query
            try {
                prettyprint(editorSubq.getValue())
                createSubquery(subqName, editorSubq.getValue());
            }
            catch(e){
                alert("Error!")
            }
        }
    });

    $('#addSubqueryPopup').on('dialogclose', function(event) {
        alert("close")
//        sessionStorage.subqcode = JSON.parse("{"+undefined+"}");
//        sessionStorage.subqname = JSON.parse("{"+undefined+"}");
        popupdisplayed = false;
        sessionStorage.popupdisplayed = 'false';
    });

    function saveqfunc(){
       // alert("hi")
        if(sessionStorage.popupdisplayed.toString() === 'true'){
//        if(!sessionStorage.subqcode || sessionStorage.subqname){
            sessionStorage.subqcode = editorSubq.getValue();
            sessionStorage.subqname = $("#subqName").val();

       }
    }

    function createSubquery(newName, newQuery){
        var currentdate = new Date();
        var datetime =
                + currentdate.getFullYear() + "-"
                + (currentdate.getMonth()+1)  + "-"
                + currentdate.getDate() + "T"
                + currentdate.getHours() + ":"
                + currentdate.getMinutes() + ":"
                + currentdate.getSeconds();

        var currentuser = "sks8";
        datetime = datetime.toString();

        $.ajax({
            type: 'POST',
            url: "http://localhost:8080/myapp/myresource/addQuery/"+newName+"/"+newQuery+"/"+currentuser+"/"+datetime, //+"/"+currentuser,
            success: function (responseData, textStatus, jqXHR) {
                alert("Query ["+newName+"] successfully added!");
                $('#addSubqueryPopup').dialog('close');
                displayFilters();
            },
            error: function (responseData, textStatus, errorThrown) {
                alert(errorThrown);
            }
        });

    }


    document.getElementById("button").addEventListener("click", function(event){
         event.preventDefault();
        sessionStorage.editorCode = editor.getValue();
        addFiltersToQuery();
//        alert(sessionStorage.editorCode)
    });
    document.getElementById("runoriginalquery").addEventListener("click", function(event){
        event.preventDefault();
        var runoriginalquerybutton = document.getElementById('runoriginalquery');
        runoriginalquerybutton.style.display = "none";
        sessionStorage.runoriginalquerybuttondisp = "false";

        addFiltersToQuery(true);

    });


    getPostsByUser.addEventListener('click', function (event) {
        location.href = "username.html?ref=" + nameclickedon;
//        sessionStorage.clickcount = document.getElementById('wholething').innerHTML;
    });

    getPostsByTopic.addEventListener('click', function (event) {
        location.href = "topicID.html?ref=" + topicIDlickedon;
//        sessionStorage.clickcount = document.getElementById('wholething').innerHTML;
    });

    getPostsByUserAndQuery.addEventListener('click', function (event) {
        var runoriginalquerybutton = document.getElementById('runoriginalquery');

        if(runoriginalquerybutton.style.display != "inline") {
            runoriginalquerybutton.style.display = "inline";
            sessionStorage.runoriginalquerybuttondisp = "true";
        }


        var code = editorX.getValue();
        var obj = JSON.parse(code);
        var filterbyuserquery = {"match": {"userName": nameclickedon.toLowerCase()}};
        filterbyuserquery = JSON.stringify(filterbyuserquery);
//        alert(filterbyuserquery)

        var filterQueryArray = obj.query.bool.filter;//['bool']['filter'];

        userFilterArray.push(filterbyuserquery);
        filterQueryArray.push(JSON.parse(filterbyuserquery));
        obj.query.bool.filter = filterQueryArray;

        editorX.setValue(JSON.stringify(obj));
        prettyprintdisplay("editorExecute");
        sendCode("editorExecute")
    });

    getPostsByTopicAndQuery.addEventListener('click', function (event) {
        var runoriginalquerybutton = document.getElementById('runoriginalquery');
        if(runoriginalquerybutton.style.display != "inline") {
            runoriginalquerybutton.style.display = "inline";
            sessionStorage.runoriginalquerybuttondisp = "true";

            //todo sessionstorage have dispakyed if displayed earlier
        }
//        sessionStorage.editorCode = editor.getValue();

        var code = editorX.getValue();
        var obj = JSON.parse(code);
        var filterbytopicquery = {"match": {"topicId": topicIDlickedon.toLowerCase()}};
        filterbytopicquery = JSON.stringify(filterbytopicquery);

        var filterQueryArray = obj.query.bool.filter;//['bool']['filter'];

        userFilterArray.push(filterbytopicquery);
        filterQueryArray.push(JSON.parse(filterbytopicquery));
        obj.query.bool.filter = filterQueryArray;

        editorX.setValue(JSON.stringify(obj));
        prettyprintdisplay("editorExecute");
        sendCode("editorExecute")
    });

    if (sessionStorage.ul) {
        alert("UL")
        sendCode('editorExecute')
    }








    function prettyprintdisplay(editorName){
        if(editorName === undefined){
            editorName = "editor";
        }

        var editor = ace.edit(editorName);
        var code = editor.getValue();

        var prettyprintedcode = prettyprint(code)

        editor.setValue(prettyprintedcode);
    }

    var allFilterObjectsArray = [];

    function displayFilters(){
        //openbox();

        var filterArray = [];

        if(sessionStorage.filterArray){
            filterArray = JSON.parse(sessionStorage.filterArray)
        }


        document.getElementById('formContainer').innerHTML = '';

        $.ajax({
            type: 'GET',
            url: "http://localhost:8080/myapp/myresource/allFilters/",
            success: function (responseData, textStatus, jqXHR) {
                var queryData = responseData;
                var c = 0;

                var filterDataDiv = document.getElementById('formContainer');


                for (var i in queryData) {
                    var queryName = queryData[i].queryName;
                    var query = queryData[i].query;


                    //alert(JSON.stringify(queryData[i]))

                    allFilterObjectsArray.push(JSON.stringify(queryData[i]));


                    var count = 1;
                    var chk = document.createElement('input');  // CREATE CHECK BOX.
                    chk.setAttribute('type', 'checkbox');// SPECIFY THE TYPE OF ELEMENT.
                    chk.setAttribute('id', 'subquery' + count);     // SET UNIQUE ID.
                    chk.setAttribute('value', queryName);
                    chk.setAttribute('name', 'subquery');
                    chk.setAttribute('class', 'filtercheckboxes');

                    var lbl = document.createElement('label');  // CREATE LABEL.
                    lbl.setAttribute('for', 'subquery' + count);
                    count++;

                    if(filterArray.includes(queryName)){
                        chk.setAttribute('checked', 'true')
                    }

                    // CREATE A TEXT NODE AND APPEND IT TO THE LABEL.
                    lbl.appendChild(document.createTextNode(queryName));
                    lbl.appendChild(document.createTextNode(': \u00A0\u00A0 \u00A0\u00A0 \u00A0\u00A0'));
                    lbl.appendChild(document.createTextNode(query));

//                        if (sessionStorage.filterArray) {
//                            if (sessionStorage.filterArray.includes(queryName)) {
//                                alert(queryName);
//                                chk.setAttribute('checked', 'checked');
//                            }
//                        }

                    // APPEND THE NEWLY CREATED CHECKBOX AND LABEL TO THE <p> ELEMENT.
                    filterDataDiv.appendChild(chk);
                    filterDataDiv.appendChild(lbl);
                    filterDataDiv.appendChild(document.createElement('br'))
                }

            },
            error: function (responseData, textStatus, errorThrown) {
                alert(errorThrown);
            }
        });

    }


    function addFiltersToQuery(runorig) {


        if(runorig){
            userFilterArray = [];
        }

        var filters = [];

        if(sessionStorage.filterArray){

//            $.each(
//                    $("input[name='subquery']"), function () {
//                        var val = $(this).val();
//                        if (sessionStorage.filterArray.includes(val)) {
//                            alert("HI "+val)
//                        }
//                    });
        }
        else {
            var filterArray = [];
        }


        $.each(
                $("input[name='subquery']"), function () {
                    var val = $(this).val();
                    if (this.checked) {
                        filters.push(val);



//                        if(sessionStorage.filterArray && !sessionStorage.filterArray.includes(val)){
//                            alert("PUSHing "+val)
////                            if(!(sessionStorage.filterArray instanceof Array))
////                                sessionStorage.filterArray = [sessionStorage.filterArray];
//                            sessionStorage.filterArray.push(JSON.parse(val))
//                        }else if(!sessionStorage.filterArray){
//                            alert("PUSH "+val)
//                            sessionStorage.filterArray = [];
////                            sessionStorage.filterArray.push(val)
//                            sessionStorage.filterArray.push(JSON.parse(val))
//
//                        }

                    }
                });
        //sessionStorage.filterArray = filters;

        sessionStorage.setItem("filterArray", JSON.stringify(filters));
        alert("FILTERS CHECKED "+filters)

        var code = editor.getValue();
        if(sessionStorage.editorXCode){
//            code = sessionStorage.editorXCode;
            editorX.setValue(sessionStorage.editorXCode)
        }


        code = getReformedCode(code);
        console.log("SO "+code)
       var obj = JSON.parse(code);
      var filterQueryArray = obj.query.bool.filter;//['bool']['filter'];


        if(filters.length>0 || userFilterArray.length>0) {


            if (filters.length > 0) {

                for (var i in filters) {
                    //  alert(filters[i]);

                    $.ajax({
                        type: 'GET',
                        url: "http://localhost:8080/myapp/myresource/filters/" + filters[i],
                        success: function (responseData, textStatus, jqXHR) {
                            var queryData = responseData;
                            var val = editor.getValue();

                            console.log("VALLLLLL ");
                            console.log(val)
//                            sessionStorage.editorCode = val;

                            for (var i in queryData) {
                                var queryName = queryData[i].queryName;
                                var query = queryData[i].query;
                                var date = queryData[i].date;
                                var author = queryData[i].author;

                                //todo if query name doesnt exist
                                if(query.charAt(0)==="{" && query.charAt(query.toString().length -1) === "}"){

                                }else{
                                    query = "{"+query+"}";
                                }

                                filterQueryArray.push(JSON.parse(query));

                                if (userFilterArray.length > 0) {
                                    for (var j = 0; j < userFilterArray.length; j++) {
                                        filterQueryArray.push(JSON.parse(userFilterArray[j]));
                                    }
                                }

                                obj.query.bool.filter = filterQueryArray;

                                editorX.setValue(JSON.stringify(obj));
                                prettyprintdisplay("editorExecute");
                            }
                            bool = true;
                            if (bool && filters.length > 0) {
                                if(userFilterArray.length > 0){
                                    for(var j=0; j<userFilterArray.length; j++) {
                                        filterQueryArray.push(JSON.parse(userFilterArray[j]));
                                    }
                                }
//                                sessionStorage.editorCode = val;
//                                sessionStorage.editorXCode = editorX.getValue();

                                sendCode('editorExecute');
                            }
                        }
                    });
                }
            }else{
                var val = editor.getValue();
//                sessionStorage.editorCode = val;

                if(userFilterArray.length > 0){
                    for(var j=0; j<userFilterArray.length; j++) {
                        filterQueryArray.push(JSON.parse(userFilterArray[j]));
                    }
                    obj.query.bool.filter = filterQueryArray;

                    editorX.setValue(JSON.stringify(obj));
//                    sessionStorage.editorXCode = editorX.getValue();

                    sendCode('editorExecute');
                }

            }
        }
        else{

            if(userFilterArray.length > 0){
                for(var j=0; j<userFilterArray.length; j++) {
                    filterQueryArray.push(JSON.parse(userFilterArray[j]));
                }
            }
            sendCode('editorExecute');

            editorX.setValue(JSON.stringify(obj));
            prettyprintdisplay("editorExecute");
//            sessionStorage.editorXCode = editorX.getValue();

            sendCode('editor')
        }

    }



    function prettyprint(jsonString){
        var jsonPretty = JSON.stringify(JSON.parse(jsonString),null,2);
        return jsonPretty;
    }



    /*
     {
     "query": {
     "match_phrase" : {
     "text" : "help"
     },
     "bool": {"subq": "lang"}
     }
     }


     {
     "query": {
     "match_phrase" : {
     "text" : "help"
     },
     "bool": [{"subq": "lang"}, {"subq": "username: mehidunno"}]
     }
     }


     {
     "query": {
     "match_phrase" : {
     "text" : "help"
     },
     "bool": [
     {"subq": "lang"},
     {"subq": "username: mehidunno"},
     {"subq": "username = cookerblocks"}
     ]
     }
     }




     */


    function getOriginalSubquery(subqname){
        var st = '';

        for(var i in allFilterObjectsArray){
            var obj = JSON.parse(allFilterObjectsArray[i]);
            if(obj.queryName.toLowerCase() === subqname.toLowerCase()){
                st = (obj.query);
            }
        }
        return st;
    }



    var cnt = 0;
    function getSubqExists(data){

        $.each(data, function(key, value) {
            if ($.isArray(value) || $.isPlainObject(value)) {
                getSubqExists(value);
            }

            if(key.toString() === "subq"){
                cnt++;
            }
        });
//        if(cnt>0)
//            return true;
//
//        return false;

        return cnt;

    }

    function getReformedCode(orignalCode){
        var code = replaceComments(JSON.parse(orignalCode));
        code = checkEmptyArr(code);
        code = prettyprint(JSON.stringify(code));

   //     while(getSubqExists(code)) {
//        var newcode = getNewCode(code);
//       var fl = checkRecursive(newcode);
//
//        var newnewcode = newcode;


        var newcode = getNewCode(code);
        cnt = 0;
        cnt = getSubqExists(JSON.parse(newcode));
        if(cnt>0){

            while(true) {
                newcode = prettyprint(newcode);
                newcode = getNewCode(newcode);

                cnt = 0;
                cnt = getSubqExists(JSON.parse(newcode));

                if(cnt==0){
                    break;
                }
            }
        }
        newcode = prettyprint(newcode);
        return newcode;

    }


    function getNewCode(code){
        var lines = code.split("\n");

        var newCode = "";
        for(var i in lines){
            var str = lines[i].trim();

            if (str.startsWith('\"subq\"')) {
                var st = str.substring(str.indexOf("\""), (str.lastIndexOf("\"")+1))

                if(str.lastIndexOf("\"")+1)
                 var restofst = str.substring(str.lastIndexOf("\"")+1);
                else
                    var restofst = "";

                var obj = JSON.parse("{"+st+"}");
                var subqname = obj[Object.keys(obj)[0]]; // an array of object keys - but only the first level


                //var subqname = st.substring(9, st.length - 1);
                //  getOriginalSubquery(subqname);
               // alert("HIIII")

                var st = getOriginalSubquery(subqname);

                var stStr = st;

                //todo
                if(st.startsWith("{") && st.endsWith("}")){
                    stStr = st.substring(1, st.length -1);
                }

                newCode = newCode + stStr + restofst;

            }
            else {
                newCode = newCode + str;
            }
        }
        return newCode;
    }

//    function replaceComments2(data) {
//        var dataString = JSON.stringify(data);
//
//        $.each(data, function(key, value) {
//            if ($.isArray(value) || $.isPlainObject(value)) {
//                replaceComments2(value);
//            }
//
//            if(key.toString().startsWith("//")){
//                delete data[key];
//            }
//            if(key.toString() === "subq"){
//
//                /*
//                 {"must": [    { "match_phrase":         { "text": "Subutex" }     },     { "match_phrase":        { "text": "methadone" }             }    ],"filter":[],"must_not":[],"should":[]}
//                 */
//
//                    try {
//                        st = JSON.parse(st);
//                    }
//                    catch (e) {
//                        st = JSON.parse("{" + st + " }")
//                    }
////                   delete data[key];
//                //var parent = key.parent;
//                data[key] = st;
//            //    alert("DATA "+JSON.stringify(data))
//                replaceComments2(data)
//
////                }
//            }
//
//            if(key.toString() === "subq2"){
//           //     alert("hey!")
//            }
//            });
//
//        return data;
//    }

//    function replaceComments3(data) {
//        $.each(data, function(key, value) {
//            if ($.isArray(value) || $.isPlainObject(value)) {
//                replaceComments3(value);
//            }
//
//            if(key.toString() === "subq"){
//              //  var st = getOriginalSubquery(data[key]);
//               //todo form key value pair json string
//                //get child
//                //replace parent with child
//
////                try {
////                    st = JSON.parse(st);
////                }
////                catch (e) {
////                    st = JSON.parse("{" + st + " }")
////                }
////                delete data[key];
////
////                data[key] = st;
//
//            }
//
//        });
//
//        return data;
//    }

    function replaceComments(data) {
        $.each(data, function(key, value) {
            if ($.isArray(value) || $.isPlainObject(value)) {
                replaceComments(value);
            }

            if(key.toString().startsWith("//")){
                delete data[key];
            }

        });
        return data;
    }



    function checkEmptyArr(data) {
        $.each(data, function(key, value) {
            if ($.isPlainObject(value) || $.isArray(value))  {
                checkEmptyArr(value);
            }
            if($.isArray(value)){
                // alert(key+" "+$.isArray(value));
                //todo remove {} from array
                data[key] = value.filter(value => Object.keys(value).length !== 0);
            }
        });
        return data;
    }



    function sendCode(editorName) {

        var editor = ace.edit(editorName);
        var origcode = editorX.getValue();

       // sessionStorage.editorCode = '';
//        sessionStorage.editorCode = origcode;
        var code = (origcode);
//        alert("new code "+code)


        //  code = replaceComments(JSON.parse(code))   //this replaces ALL commented keys
        //  code = checkEmptyArr(code);

//        sessionStorage.editorXCode = '';
        sessionStorage.editorXCode = code;

//        alert("Set val "+code)
        editorX.setValue(code);
        prettyprintdisplay("editorExecute");

        $('#ajaxError').ajaxError(function (e, xhr, settings, exception) {
            $(this).text('Error in: ' + settings.url + ' - Error: ' +
                    exception + " - Response: " + xhr.responseText);
        });

        $.ajax({
            type: 'GET',
            url: "http://localhost:8080/myapp/myresource/query/" + code,
            success: function (responseData, textStatus, jqXHR) {
//            console.log(responseData)

//            alert(responseData)
                var data = responseData;
                var c = 0;

                var ul = document.getElementById('posts');

                if ($('#posts').children().length > 0) {
                    ul.innerHTML = '';
                }

                for (var i in data) {
                    var status = data[i].userStatus;
                    var name = data[i].userName;

                    var postTime = data[i].postTime;

                    var userRegDate = data[i].userRegDate;
                    var userPostCount = data[i].userPostCount;

                    var text = data[i].text;
                    var topicName = data[i].topicName;
                    var topicID = data[i].topicId;


                    var div = document.createElement('div');
                    div.id = 'post';
                    div.className = 'post';
                    div.style.display = "block";

                    if (div.style.visibility == "hidden")
                        div.style.visibility = "visible";

                    div.style.border = "dodgerblue"

//                var postTimeInfo = document.getElementById('postTime');
                    var postTimeInfo = document.createElement('div');
                    postTimeInfo.id = 'postTime';
                    postTimeInfo.class = 'postTime';
                    postTimeInfo.style.width = 'inherit';
                    postTimeInfo.style.height = '20px';
                    postTimeInfo.style.backgroundColor = 'dodgerblue';
                    postTimeInfo.style.color = 'white';
                    postTimeInfo.innerText = postTime;

                    var userInfo = document.createElement('div');
                    userInfo.id = 'userInfo';
                    userInfo.class = 'userInfo';
                    userInfo.style.width = '28%';
                    userInfo.style.height = 'inherit';
                    userInfo.style.padding = '1%';
                    userInfo.style.float = 'left';
                    userInfo.style.display = 'block';
                    userInfo.style.backgroundColor = 'whitesmoke';


//                var userNameInfo = document.getElementById('userName');
                    var userNameInfo = document.createElement('div');
                    userNameInfo.id = 'userName';
                    userNameInfo.class = 'userName margin0';
                    userNameInfo.innerText = name;
//                userNameInfo.href = "username.html?ref="+name;
                    userNameInfo.style.fontWeight = "bold";
                    userNameInfo.style.fontSize = "18px";
                    userNameInfo.style.color = "dodgerblue";
                    userNameInfo.style.lineBreak = "auto";

                    userNameInfo.addEventListener('contextmenu', function () {
                        event.preventDefault();
                        nameclickedon = event.target.innerText;
                        usermenu.style.display = "block";
                        usermenu.style.left = (event.pageX - 10) + "px";
                        usermenu.style.top = (event.pageY - 10) + "px";
                        userMenuDisplayed = true;
                    });
                    usermenu.addEventListener("click", function (event) {
                        if (userMenuDisplayed) {
                            userMenuDisplayed = false;
                            usermenu.style.display = "";
                            usermenu.style.left = "";
                            usermenu.style.top = "";
                            var runoriginalquerybutton = document.getElementById('runoriginalquery');
                            runoriginalquerybutton.style.display = "";
                            sessionStorage.runoriginalquerybuttondisp = "false";

                        }
                    }, false);
                    window.addEventListener("click", function (event) {
                        if (userMenuDisplayed) {
                            userMenuDisplayed = false;
                            usermenu.style.display = "";
                            usermenu.style.left = "";
                            usermenu.style.top = "";
                            var runoriginalquerybutton = document.getElementById('runoriginalquery');
                            runoriginalquerybutton.style.display = "none";
                            sessionStorage.runoriginalquerybuttondisp = "false";

                        }
                    }, false);

//                var userStatusInfo = document.getElementById('userStatus');
                    var userStatusInfo = document.createElement('div');
                    userStatusInfo.id = 'userStatus';
                    userStatusInfo.class = 'userStatus margin0';
                    userStatusInfo.innerText = status;
                    userStatusInfo.style.fontWeight = "bold";
                    userNameInfo.style.lineBreak = "auto";

//                var userRegDateInfo = document.getElementById('userRegDate');
                    var userRegDateInfo = document.createElement('div');
                    userRegDateInfo.id = 'userRegDate';
                    userRegDateInfo.class = 'userRegDate margin0';
                    userRegDateInfo.innerText = "Registered : " + userRegDate;
                    userRegDateInfo.style.lineBreak = "auto";

//                var userPostCountInfo = document.getElementById('userPostCount');
                    var userPostCountInfo = document.createElement('div');
                    userPostCountInfo.id = 'userPostCount';
                    userPostCountInfo.class = 'userPostCount margin0';
                    userPostCountInfo.innerText = "Posts : " + userPostCount;
                    userPostCountInfo.style.lineBreak = "auto";

//                var topicNameInfo = document.getElementById('topicName');
                    var topicNameInfo = document.createElement('div');
                    topicNameInfo.id = 'topicName';
                    topicNameInfo.class = 'topicName margin0';
                    topicNameInfo.innerText = topicName;
//                        topicNameInfo.href = "topicID.html?ref=" + topicID;
                    topicNameInfo.style.fontWeight = "bold";
                    topicNameInfo.style.lineBreak = "auto";

                    var topicIDInfo = document.createElement('div');
                    topicIDInfo.id = 'topicID';
                    topicIDInfo.class = 'topicID margin0';
                    topicIDInfo.innerText = topicID;
//                        topicNameInfo.href = "topicID.html?ref=" + topicID;
                    topicIDInfo.style.fontWeight = "bold";
                    topicIDInfo.style.lineBreak = "auto";


                    topicIDInfo.addEventListener('contextmenu', function () {
                        event.preventDefault();
                        topicIDlickedon = event.target.innerText;
                        topicmenu.style.display = "block";
                        topicmenu.style.left = (event.pageX - 10) + "px";
                        topicmenu.style.top = (event.pageY - 10) + "px";
                        topicMenuDisplayed = true;
                    });
                    topicmenu.addEventListener("click", function (event) {
                        if (topicMenuDisplayed) {
                            topicMenuDisplayed = false;
                            topicmenu.style.display = "";
                            topicmenu.style.left = "";
                            topicmenu.style.top = "";
                            //todo
                            var runoriginalquerybutton = document.getElementById('runoriginalquery');
                            runoriginalquerybutton.style.display = "";
                            sessionStorage.runoriginalquerybuttondisp = "false";

                        }
                    }, false);
                    window.addEventListener("click", function (event) {
                        if (topicMenuDisplayed) {
                            topicMenuDisplayed = false;
                            topicmenu.style.display = "";
                            topicmenu.style.left = "";
                            topicmenu.style.top = "";
                            //todo
                            var runoriginalquerybutton = document.getElementById('runoriginalquery');
                            runoriginalquerybutton.style.display = "none";
                            sessionStorage.runoriginalquerybuttondisp = "false";

                        }
                    }, false);

//                var textInfo = document.getElementById('text');
                    var textInfo = document.createElement('div');
                    textInfo.id = 'text';
                    textInfo.class = 'info margin0';
                    textInfo.innerText = text;
                    textInfo.style.width = "68%";
                    textInfo.style.padding = "1%";
                    textInfo.style.height = "inherit";
                    textInfo.style.float = "right";
                    textInfo.style.display = "block";
//                textInfo.style.backgroundColor = "gray";
                    textInfo.style.lineBreak = "auto";

                    //c++;

                    userInfo.appendChild(userNameInfo);
                    userInfo.appendChild(userStatusInfo);
                    userInfo.appendChild(document.createElement('br'));
                    userInfo.appendChild(userRegDateInfo);
                    userInfo.appendChild(userPostCountInfo);
                    userInfo.appendChild(document.createElement('br'));
                    userInfo.appendChild(topicNameInfo);
                    userInfo.appendChild(topicIDInfo);

                    div.appendChild(postTimeInfo);
                    div.appendChild(userInfo);
                    div.appendChild(textInfo);
//                if(c != data.length) {
//                    var post = document.getElementById('post');

//                    li.appendChild(div);
                    ul.appendChild(div);
                    // }
                }
                sessionStorage.ul = '';
                sessionStorage.ul = ul.innerHTML;


            },
            error: function (responseData, textStatus, errorThrown) {
                alert(errorThrown);
            }


        });

    }
    //    sessionStorage.editorCode = editor.getValue();
    //    alert("HI SESH "+sessionStorage.editorCode);

    function displaywholequery(){

    }








</script>


</html>