
<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Subqueries</title>
    <meta name="description" content="Dashboard">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="apple-touch-icon" href="apple-icon.png">
    <link rel="shortcut icon" href="favicon.ico">

    <link rel="stylesheet" href="vendors/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="vendors/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="vendors/themify-icons/css/themify-icons.css">
    <link rel="stylesheet" href="vendors/flag-icon-css/css/flag-icon.min.css">
    <link rel="stylesheet" href="vendors/selectFX/css/cs-skin-elastic.css">
    <link rel="stylesheet" href="vendors/jqvmap/dist/jqvmap.min.css">

    <link rel="stylesheet" href="assets/style.css">

    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800' rel='stylesheet' type='text/css'>
    <style type="text/css" media="screen">
        #editor {
            width: 1000px;
            height: 400px;
        }

        .li{
            display: inline-block;;
        }
        /*.float-right{*/
        /*display: inline-block;*/
        /*}*/

        .post{
            background: lightgrey;
            width: 1000px;
            height: auto;
            border: hidden;
            text-align: left;
            color: black;
            font-size: 12px;
            margin-bottom: 10px;
            overflow-y: auto;
        }


        #chat{
            width: 1000px;
            height: 400px;
            border-style: solid;
            border-color: dodgerblue;
            border-width: 2px;
        }

        .collapsible{
            display: block;
            background: none;
            border: none;
        }

        #username{
            font-size: 20px;
            color: white;
        }

        #userHref{
            font-size: 20px;
            color: white;
        }


        #postInfo{
            display: inline-block;
            font-size: 14px;
        }

        #topicInfo{
            display: inline-block;
            font-size: 14px;
        }

        #forumId{
            display: inline-block;
            font-size: 14px;
        }

        .chat {
            /*width: 1000px;*/
            /*height: 400px;*/
            border: dodgerblue;

        }

        .postTime{
            width: inherit;
            height: 20px;
            background-color: dodgerblue;
            color: white;
        }

        .userInfo{
            width: 28%;
            height: inherit;
            padding: 1%;
            float: left;
            display: block;
            background-color: whitesmoke;
        }

        .info{
            width: 68%;
            padding: 1%;
            height: inherit;
            float: right;
            display: block;
            background-color: gray;
        }

        .margin0{
            margin: 0;
            line-break: auto;
            font-size: small;
            padding-left: 15px;
        }

        .queryName{
            font-weight: bold;
            font-size: 18px;
            color: dodgerblue;
        }
        .query{
            font-weight: bold;
            font-size: 14px;

        }

        .date, .author{
            font-size: 12px;
        }

        .editSubqButton{
            width: 150px;
            height: 30px;
            padding-left: 15px;
            margin-left: 15px;
            display: block;
        }

        .deleteSubqButton{
            width: 150px;
            height: 30px;
            margin-left: 15px;
            padding-left: 15px;
            display: block;
        }



        #addFilterButton{

        }

        #nameofquery{
            width: 400px;
            height:40px;
            display: block;
            padding-left: 5px;
            margin-left: 20px;
        }

        #newSubquery{
            width:400px;
            height:300px;
            display: block;
            padding-left: 5px;
            margin-left: 20px;
        }

        #createSubqueryButton{
            display: inline;
            margin-left: 20px;
        }

        #subqname{
            font-weight: bold;
        }



        button{
            cursor: pointer;
        }



        menu {
            position:absolute;
            display:block;
            left:0px;
            top:0px;
            height:20px;
            width:20px;
            padding:0;
            margin:0;
            border:1px solid;
            background-color:white;
            font-weight:normal;
            white-space:nowrap;
        }
        menu:hover{
            background-color:#eef;
            font-weight:bold;
        }
        menu:hover > menu{
            display:block;
        }
        menu > menu{
            display:none;
            position:relative;
            top:-20px;
            left:100%;
            width:55px;
        }
        menu[title]:before{
            content:attr(title);
        }
        menu:not([title]):before{
            content:"\2630";
        }
    </style>
</head>



<body>


<!-- Left Panel -->

<aside id="left-panel" class="left-panel">
    <nav class="navbar navbar-expand-sm navbar-default" style="position: fixed">

        <div id="main-menu" class="main-menu collapse navbar-collapse">
            <ul style="list-style: none" class="nav navbar-nav">
                <li class="active">
                    <a href="backup.html"> <i class="menu-icon fa fa-dashboard"></i>Dashboard </a>
                </li>
                <h3 class="menu-title">SEARCH</h3><!-- /.menu-title -->
                <li class="menu-item-has-children dropdown">
                    <!--<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> <i class="menu-icon fa fa-laptop"></i>SEARCH</a>-->
                    <ul class="sub-menu children dropdown-menu">
                        <li><i class="fa fa-puzzle-piece"></i><a href="backup.html" onclick="return saveqfunc()">Search Posts</a></li>
                    </ul>
                </li>

                <h3 class="menu-title">SUBQUERIES</h3><!-- /.menu-title -->
                <li class="menu-item-has-children dropdown">
                    <!--<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> <i class="menu-icon fa fa-tasks"></i>SubQueries</a>-->
                    <ul class="sub-menu children dropdown-menu">
                        <li><i class="menu-icon fa fa-fort-awesome"></i><a href="all.html" onclick="return saveqfunc()">All</a></li>
                    </ul>
                </li>
                <h3 class="menu-title">EXTRAS</h3><!-- /.menu-title -->
                <li class="menu-item-has-children dropdown">
                    <!--<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> <i class="menu-icon fa fa-glass"></i>Extras</a>-->
                    <ul class="sub-menu children dropdown-menu">
                        <li><i class="menu-icon fa fa-sign-in"></i><a href="page-login.html" onclick="return saveqfunc()">Logout</a></li>
                        <li><i class="menu-icon fa fa-sign-in"></i><a href="" onclick="return saveqfunc()">Guide to Dashboard</a></li>
                        <li><i class="menu-icon fa fa-sign-in"></i><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html" onclick="return saveqfunc()">ElasticSearch Reference</a></li>

                    </ul>
                </li>
            </ul>
        </div><!-- /.navbar-collapse -->
    </nav>
</aside><!-- /#left-panel -->

<!-- Left Panel -->

<!-- Right Panel -->

<div id="right-panel" class="right-panel">

    <!-- Header-->
    <header id="header" class="header">

        <div class="header-menu">

        </div>

    </header><!-- /header -->
    <!-- Header-->

    <div class="breadcrumbs">
        <div class="col-sm-4">
            <div class="page-header float-left">
                <div class="page-title">
                    <h1>Subqueries</h1>
                </div>
            </div>
        </div>



    </div>

    <div class="break" style="padding-top: 20px"></div>


    <div>
        <input id="nameofquery"> </input>
        <br>
        <div id="editor">"filter": {
        "term": {
          "userName": "mehidunno"
        }
      }
        </div>
        <br>
        <button id="createSubqueryButton"  onclick=createSubquery()>Create Subquery</button>
        <button id="createprettyprint" style="display: inline; margin-left: 20px">Pretty print</button>

    </div>

    <!--<div id="mainDiv" class="mainDiv">-->
        <ul  class="subqueries" id="subqueries"></ul>
    <!--</div>-->


    <div id="addSubqueryPopup" title="Create Subquery" style="display: none; ">
        <label>Query name:</label>
        <label id="subqname"></label>
        <br>
        <div id="subqEditor" style="display: block; margin-top: 10px; width: 700px; height: 400px; font-size: 12px"></div>
        <br>
        <button id="confirmButton" style="display: inline;">Confirm</button>
        <button id="prettyprint" style="display: inline; margin-left: 20px">Pretty print</button>
    </div>

</div><!-- /#right-panel -->

<!-- Right Panel -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.1/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.1/theme-cobalt.js" integrity="sha256-OEJvWvZJvQ8cFFLk43d1UF5DHqWdikG1n8CJQSP70TA=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.1/mode-yaml.js" integrity="sha256-95xNUgbfIXvRXJezV53+JM5HPO6PnJ+wZ7/GwdesKAE=" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>


<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>

<script src="https://code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>

<link rel="stylesheet" href="https://code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css" />


<script>
    var currentuser = "sks8";
    var dialogOpen = false;


    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/json");

    //    editor.setTheme( "ace/theme/cobalt" );
    //    editor.getSession().setMode( "ace/mode/yaml" );
    editor.focus();
    editor.setOptions({
        enableBasicAutocompletion: true,
        enableSnippets: true,
        enableLiveAutocompletion: true
    });

    if(sessionStorage.createqcode){
        editor.setValue(sessionStorage.createqcode )
    }

//    alert(sessionStorage.editorCode)
//    alert(sessionStorage.editorXCode)


    var subqEditor = ace.edit("subqEditor");
    subqEditor.setTheme("ace/theme/monokai");
    subqEditor.session.setMode("ace/mode/json");

    //    editor.setTheme( "ace/theme/cobalt" );
    //    editor.getSession().setMode( "ace/mode/yaml" );
    subqEditor.focus();
    subqEditor.setOptions({
        enableBasicAutocompletion: true,
        enableSnippets: true,
        enableLiveAutocompletion: true
    });
    var subdiv = document.getElementById('subqueries');
//    var maindiv = document.getElementById('mainDiv');
    var allFilterObjectsArray = [];
    var nameclickedon = '';


    $("#createprettyprint").click(function(){
        editor.setValue(prettyprint(editor.getValue()))
    });

    display();

    function saveqfunc(){
        sessionStorage.createqcode = editor.getValue();
        if(dialogOpen){
            sessionStorage.codeindialog = subqEditor.getValue();
        }
    }


    function display() {
        allFilterObjectsArray = [];
        subdiv.innerHTML = '';
        $.ajax({
            type: 'GET',
            url: "http://localhost:8080/myapp/myresource/allFilters/",
            success: function (responseData, textStatus, jqXHR) {
                console.log(responseData);
                var queryData = responseData;
                var c = 0;

                for (var i in queryData) {
                    allFilterObjectsArray.push(queryData[i]);
                    var queryName = queryData[i].queryName;
                    var query = queryData[i].query;
                    var date = queryData[i].date;
                    var author = queryData[i].author;

                    var li = document.createElement('li');
                    li.setAttribute('id', "LI "+queryName);
                    li.style.listStyle = "none";

                    var buttonid = "button "+queryName;
                    li.innerHTML = '<div>' +
                            '<p class="queryName margin0">' + queryName + '</p>' +
                            '<p class="query margin0" id=\"'+queryName+'\">' + query + '</p>' +
                            '<button id=\"'+buttonid+'\" class="editSubqButton margin0" value=\"'+queryName+'\"onclick=editSubq(this)>Edit Subquery</button>' +
                    '<br>' +
                            '<p class="date margin0">Date: ' + date + '</p>' +
                            '<p class="author margin0">Author: ' + author + '</p>' +
                            '<button class="deleteSubqButton margin0" value=\"'+queryName+'\"onclick=deleteSubq(this)>Delete Subquery</button>'
                            '</div>';

                    subdiv.appendChild(li);
                    subdiv.appendChild(document.createElement('br'))

                }

                if(sessionStorage.dialogopensubqname){
                    alert(sessionStorage.dialogopensubqname)
                    dialogOpen = false;
//                    sessionStorage.dialogopensubqname = undefined;
                        var obj = document.getElementById('button '+sessionStorage.dialogopensubqname);
                        editSubq(obj)
                }
            },
            error: function (responseData, textStatus, errorThrown) {
                alert(errorThrown);
            }
        });
    }

    function createSubquery() {
        var existsAlreadyFlag = false;
        for (var i in allFilterObjectsArray) {
            var obj = (allFilterObjectsArray[i]);
            if (obj.queryName.toLowerCase() === $('#nameofquery').val().toLowerCase()) {
                existsAlreadyFlag = true;
                break;
            }
        }

        if (existsAlreadyFlag) {
            alert("Error! Subquery Exists already!")
            $('#addSubqueryPopup').dialog('close');
        }
        else {
            //adding query
            var newSubqueryDiv = ace.edit("editor");

            var newName = $('#nameofquery').val();

            var newQuery = newSubqueryDiv.getValue();

//        newNameDiv.innerHTML = "";
//        newSubqueryDiv.innerHTML = "";

            try {
                prettyprint(newQuery);
                var currentdate = new Date();
                var datetime =
                        +currentdate.getFullYear() + "-"
                        + (currentdate.getMonth() + 1) + "-"
                        + currentdate.getDate() + "T"
                        + currentdate.getHours() + ":"
                        + currentdate.getMinutes() + ":"
                        + currentdate.getSeconds();

                datetime = datetime.toString();

                $.ajax({
                    type: 'POST',
                    url: "http://localhost:8080/myapp/myresource/addQuery/" + newName + "/" + newQuery + "/" + currentuser + "/" + datetime, //+"/"+currentuser,
                    success: function (responseData, textStatus, jqXHR) {
                        alert("Subquery created successfully!");
                        display();
                    },
                    error: function (responseData, textStatus, errorThrown) {
                        alert("ERROR "+errorThrown);
                    }
                });
            }
            catch(e){
                alert("Error!")
            }



        }
    }


    function deleteSubq(obj){
        var subqname = obj.value;
        alert(subqname)

        $.ajax({
            type: 'DELETE',
            url: "http://localhost:8080/myapp/myresource/deleteFilter/"+subqname,
            success: function (responseData, textStatus, jqXHR) {
                alert("Deleted!")
                display();
            },
            error: function (responseData, textStatus, errorThrown) {
                alert("ERROR " + errorThrown);
            }
        });
    }

    function editSubq(obj){
        var subqname = obj.value;
        var currentdate = new Date();
        var datetime =
                +currentdate.getFullYear() + "-"
                + (currentdate.getMonth() + 1) + "-"
                + currentdate.getDate() + "T"
                + currentdate.getHours() + ":"
                + currentdate.getMinutes() + ":"
                + currentdate.getSeconds();

        datetime = datetime.toString();

        dialogOpen = true;
        sessionStorage.dialogopensubqname = subqname;

        //display dialog box
        $( "#addSubqueryPopup").dialog({
            width: 750,
            height: 600
        });
        $("#subqname").text(subqname);
        var q = document.getElementById(subqname);

        subqEditor.setValue((q.innerHTML));
        if(sessionStorage.codeindialog){
            var newQuery = sessionStorage.codeindialog;
            subqEditor.setValue((newQuery));
        }

        $("#prettyprint").click(function(){
           subqEditor.setValue(prettyprint(subqEditor.getValue()))
        });


        $('#confirmButton').click(function(){
            var newQuery = subqEditor.getValue();

            var url = "http://localhost:8080/myapp/myresource/editFilter/"+subqname+"/"+newQuery+"/"+currentuser+"/"+datetime;

            $.ajax({
                type: 'POST',
                url: url,
                success: function (responseData, textStatus, jqXHR) {
                    alert("Edited successfully!");
                    $('#addSubqueryPopup').dialog('close');
                    dialogOpen = false;
                    sessionStorage.dialogopensubqname = undefined;
                    display();

                },
                error: function (responseData, textStatus, errorThrown) {
                    alert("ERROR " + errorThrown);
                }
            });

        });


    }

    $('#addSubqueryPopup').on('dialogclose', function(event) {
        dialogOpen = false;
        sessionStorage.dialogopensubqname = undefined;
    });

    function prettyprint(jsonstring){
        var jsonPretty = JSON.stringify(JSON.parse(jsonstring),null,2);
        return jsonPretty;
    }


</script>


</body>

</html>